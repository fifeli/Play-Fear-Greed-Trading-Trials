<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fear & Greed: Trading Trials (Prototype)</title>
<style>
  :root{--bg:#0b1020;--panel:#0f1724;--accent:#ffd166;--fear:#4da6ff;--greed:#ff8b5a;--muted:#98a0b3;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#061021 0%, #081428 100%);font-family:Inter,Segoe UI,Roboto,Arial;}
  .wrap{display:flex;gap:16px;padding:18px;box-sizing:border-box;height:100%;}
  .left{flex:1;display:flex;flex-direction:column;gap:12px;}
  .canvas-panel{background:rgba(255,255,255,0.02);border-radius:12px;padding:12px;box-shadow:0 6px 24px rgba(3,6,12,0.6);display:flex;flex-direction:column;align-items:stretch;}
  canvas{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));border-radius:8px;}
  .top-row{display:flex;justify-content:space-between;align-items:center;gap:12px;}
  .stats{display:flex;gap:12px;color:var(--muted);}
  .stat{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px;min-width:120px;text-align:center;}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  button{background:linear-gradient(180deg,#111827,#0b1220);border:1px solid rgba(255,255,255,0.04);color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer;min-width:92px;}
  button:active{transform:translateY(1px);}
  .big{font-weight:700;font-size:1.05rem;}
  .meter-wrap{width:220px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
  .meter{height:18px;background:linear-gradient(90deg,#4f85ff,#ffd166,#ff7b6a);border-radius:9px;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.03);}
  .meter-fill{position:absolute;height:100%;left:0;top:0;background:rgba(0,0,0,0.12);mix-blend-mode:overlay;}
  .meter-label{display:flex;justify-content:space-between;color:var(--muted);font-size:0.85rem;margin-top:8px;}
  .right{width:360px;display:flex;flex-direction:column;gap:12px;}
  .panel{background:var(--panel);padding:12px;border-radius:12px;color:#e6eef8;}
  .news{min-height:64px;border-radius:8px;padding:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:var(--muted);display:flex;align-items:center;justify-content:center;font-style:italic;}
  .log{height:140px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01));padding:8px;border-radius:8px;font-size:0.9rem;color:var(--muted);} 
  .small{font-size:0.85rem;color:var(--muted);}
  .speed{display:flex;gap:8px;align-items:center;}
  .hint{font-size:0.85rem;color:#c9d2e6;}
  .footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:0.85rem;padding-top:6px;}
  .pulse{animation:pulse 1s infinite ease-in-out;}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,0.02);}50%{box-shadow:0 0 24px 6px rgba(255,255,255,0.01);}100%{box-shadow:0 0 0 0 rgba(255,255,255,0.02);}}
  .danger{color:#ff8b6a;font-weight:700;}
  .success{color:#7bed9f;font-weight:700;}
  .center{display:flex;align-items:center;justify-content:center;gap:8px;}
  .meter-value{font-weight:700;}
  .controls-col{display:flex;flex-direction:column;gap:8px;}
  .trade-btn{min-width:140px;padding:12px 14px;font-weight:700;}
  .allin{background:linear-gradient(180deg,#ff8b5a,#ff6a3a);}
  .panic{background:linear-gradient(180deg,#4da6ff,#1e90ff);}
  .note{font-size:0.8rem;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <div class="canvas-panel">
      <div class="top-row">
        <div class="stats">
          <div class="stat">
            <div class="small">Portfolio</div>
            <div id="portfolio" class="big">$10,000</div>
            <div class="small" id="holdings">Holdings: 0 MC</div>
          </div>
          <div class="stat">
            <div class="small">Cash</div>
            <div id="cash" class="big">$10,000</div>
            <div class="small" id="nav">Net Worth: $10,000</div>
          </div>
          <div class="stat">
            <div class="small">Price</div>
            <div id="price" class="big">$100</div>
            <div class="small" id="tick">Tick: 0</div>
          </div>
        </div>
        <div class="meter-wrap">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
            <div class="small">Fear — Balance — Greed</div>
            <div id="meter-number" class="meter-value">50</div>
          </div>
          <div class="meter" id="meter">
            <div class="meter-fill" id="meter-fill" style="width:50%;"></div>
          </div>
          <div class="meter-label">
            <span class="small">Fear</span><span class="small">Balanced</span><span class="small">Greed</span>
          </div>
        </div>
      </div>

      <canvas id="chart" width="1100" height="360" style="width:100%;height:360px;border-radius:8px;margin-top:12px;"></canvas>

      <div style="display:flex;justify-content:space-between;margin-top:12px;gap:12px;align-items:center;">
        <div class="controls">
          <div class="controls-col">
            <div class="center">
              <button id="buy" class="trade-btn">Buy (10%)</button>
              <button id="sell" class="trade-btn">Sell (10%)</button>
            </div>
            <div class="center">
              <button id="allin" class="trade-btn allin">All-In</button>
              <button id="panic" class="trade-btn panic">Panic Sell</button>
            </div>
            <div class="center hint note">Click buy/sell to trade 10% of cash/holdings. All-In/panic sell are big emotional choices.</div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
          <div class="speed small">Speed: <input id="speed" type="range" min="0.25" max="4" step="0.25" value="1" style="width:140px;"></div>
          <div id="timer" class="small">Time: 0:00 / 5:00</div>
          <div id="status" class="small">Status: Ready</div>
        </div>
      </div>
      <div class="footer">
        <div class="small">Prototype: scripted 5 minute loop · press Start to play</div>
        <div>
          <button id="start">Start</button>
          <button id="reset">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="panel news" id="news">No news yet — the market is calm.</div>
    <div class="panel log" id="log"></div>
    <div class="panel">
      <div class="small">Session Summary</div>
      <div id="summary" style="margin-top:8px;font-size:0.95rem;color:var(--muted);">Start a run to see the summary here.</div>
    </div>
    <div class="panel">
      <div class="small">Playback Controls</div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="step">Step Tick</button>
        <button id="pause">Pause</button>
        <button id="resume">Resume</button>
      </div>
      <div class="note" style="margin-top:8px;">Use speed slider to speed up the demo. Step advances one tick (3 seconds) at a time.</div>
    </div>
  </div>
</div>

<script>
/* === Configuration & Data (scripted table per prototype) === */
const TICK_DURATION_BASE = 3000; // ms per tick at speed 1.0
const TICKS_TOTAL = 100; // 5 minutes @3s per tick
const START_PRICE = 100;
const SCRIPTED = [
  // Prices for ticks 1..100 (from the table)
  101,102,103,104,105,106,107,108,109,110,110,111,111,112,112,113,115,118,121,125,
  124,122,120,117,115,113,110,108,106,105,100,98,95,95,96,97,98,99,100,102,
  103,105,107,110,115,120,125,128,130,127,124,120,115,110,105,100,98,95,95,96,
  97,98,100,102,105,110,115,118,120,130,128,125,122,118,110,100,95,92,90,92,
  94,96,100,102,105,110,115,118,120,125
];
const NEWS_MAP = {
  15: "Experts predict steady growth — could be the start of a rally.",
  20: "MarketCoin breaking records — traders going all-in!",
  30: "Rumors of a crash ahead — protect your gains.",
  35: "Crash fears overblown — smart money is buying.",
  59: "Decision time — ride the wave or lock in your gains?"
};

/* === State === */
let tick = 0;
let running = false;
let timerId = null;
let speed = 1;
let cash = 10000;
let holdings = 0; // in MarketCoin units
let portfolio = 10000; // net worth
let price = START_PRICE;
let meter = 50; // 0 fear -> 100 greed, start 50
let logEl, priceEl, cashEl, portEl, holdingsEl, meterFillEl, meterNumEl, newsEl, tickEl, timerEl, statusEl, summaryEl;
let chartCanvas, ctx, chartData = [];
let lastTradeTick = -999;
let inPlayStart = null;
let passiveBalancedTimer = 0;

/* === Helpers === */
function money(n){ return '$' + n.toFixed(2); }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function pushLog(txt, cls=''){ const d = document.createElement('div'); d.textContent = txt; if(cls) d.className=cls; logEl.prepend(d); }
function updateUI(){
  priceEl.textContent = money(price);
  cashEl.textContent = money(cash);
  portEl.textContent = money(portfolio);
  holdingsEl.textContent = `Holdings: ${holdings.toFixed(4)} MC`;
  meterNumEl.textContent = Math.round(meter);
  meterFillEl.style.width = `${clamp((meter/100)*100,0,100)}%`;
  tickEl.textContent = `Tick: ${tick}`;
  timerEl.textContent = `Time: ${formatTime(Math.round((tick/ TICKS_TOTAL) * 5*60))} / 5:00`;
}
function formatTime(s){ const mm = Math.floor(s/60); const ss = s%60; return `${mm}:${ss.toString().padStart(2,'0')}`; }
function recalcPortfolio(){ portfolio = cash + holdings * price; updateUI(); }

/* === Meter Logic per spec === */
function changeMeter(delta, reason=''){
  meter = clamp(meter + delta, 0, 100);
  if(Math.abs(delta) >= 10){
    // strong pulse
    meterFillEl.classList.add('pulse');
    setTimeout(()=>meterFillEl.classList.remove('pulse'), 700);
  }
  pushLog(`Meter ${delta>0?'+':''}${delta} (${reason})`);
  // penalties & rewards handled elsewhere
  updateUI();
}

/* === Trade actions === */
function buyPercent(pct){
  const spend = cash * pct;
  if(spend < 1) { pushLog('Not enough cash to buy.'); return; }
  const qty = spend / price;
  cash -= spend;
  holdings += qty;
  lastTradeTick = tick;
  changeMeter(pct >= 0.5 ? 5 : 2, `Buy ${Math.round(pct*100)}%`);
  pushLog(`Bought ${qty.toFixed(4)} MC for ${money(spend)}.`);
  recalcPortfolio();
}
function sellPercent(pct){
  const sellQty = holdings * pct;
  if(sellQty <= 0) { pushLog('No holdings to sell.'); return; }
  const gain = sellQty * price;
  holdings -= sellQty;
  cash += gain;
  lastTradeTick = tick;
  changeMeter(pct >= 0.5 ? -5 : -2, `Sell ${Math.round(pct*100)}%`);
  pushLog(`Sold ${sellQty.toFixed(4)} MC for ${money(gain)}.`);
  recalcPortfolio();
}
function allIn(){
  if(cash <= 1) { pushLog('Not enough cash for All-In.'); return; }
  const spend = cash;
  const qty = spend / price;
  holdings += qty;
  cash = 0;
  lastTradeTick = tick;
  changeMeter(15, 'All-In');
  pushLog('ALL-IN: Converted all cash to holdings.');
  recalcPortfolio();
}
function panicSell(){
  if(holdings <= 0){ pushLog('No holdings to panic sell.'); return; }
  const gain = holdings * price;
  cash += gain;
  pushLog(`PANIC SELL: Liquidated ${holdings.toFixed(4)} MC for ${money(gain)}.`);
  holdings = 0;
  lastTradeTick = tick;
  changeMeter(-15, 'Panic Sell');
  recalcPortfolio();
}

/* === Scripted tick handling === */
function applyScriptTick(){
  if(tick >= TICKS_TOTAL){ finishRun(); return; }
  // set price based on SCRIPTED array (ticks start indexing at 1)
  price = SCRIPTED[tick] || price;
  chartData.push(price);
  // news
  if(NEWS_MAP[tick]){
    newsEl.textContent = NEWS_MAP[tick];
    pushLog(`News: ${NEWS_MAP[tick]}`);
    // optional meter nudges on seeing news if reacting: handled when player acts;
  } else {
    newsEl.textContent = 'Market is calm.';
  }

  // Meter effects from holding during big moves: check last few ticks
  if(tick >= 4){
    const recent = chartData.slice(-5);
    const old = recent[0], cur = recent[recent.length-1];
    const percent = ((cur - old)/old)*100;
    if(percent >= 10){ // holding during big rise
      changeMeter(3, 'Held through big rise');
    } else if(percent <= -10){ // holding through big drop
      changeMeter(-3, 'Held through big drop');
    }
  }

  // Periodic balanced reward
  if(meter >=40 && meter<=60){ passiveBalancedTimer += 1; if(passiveBalancedTimer >= 10){ // every ~30 sec at speed 1
    cash *= 1.01; passiveBalancedTimer = 0; pushLog('Balanced reward: +1% cash bonus.'); recalcPortfolio(); }} else passiveBalancedTimer = 0;

  // Decay toward center every 10 seconds of no trade
  if(tick - lastTradeTick >= 4){ // every ~12 seconds
    const towards = 50;
    const d = (towards - meter) > 0 ? 1 : -1;
    changeMeter(d, 'Natural decay');
  }

  // Penalty checks
  if(meter < 25){
    // extreme fear penalty: cap growth - implemented by reducing potential gains when price increases
    // Implemented via logging; actual cap applied when portfolio changes via price update
    pushLog('WARNING: Extreme fear active — portfolio growth will be capped.');
  }
  if(meter > 75){
    pushLog('WARNING: Extreme greed active — next drop will hit harder on your holdings.');
  }

  // If greed extreme and next price drop, we double the hit — achieved via a flag
  // We'll handle that when price decreases by checking previous value
  drawChart();
  recalcPortfolio();
  updateUI();

  tick += 1;
}

/* === Chart Drawing === */
function drawChart(){
  const w = chartCanvas.width;
  const h = chartCanvas.height;
  ctx.clearRect(0,0,w,h);
  // grid
  ctx.strokeStyle = 'rgba(255,255,255,0.03)';
  ctx.lineWidth = 1;
  for(let i=0;i<5;i++){
    ctx.beginPath();
    ctx.moveTo(0, h * (i/4));
    ctx.lineTo(w, h * (i/4));
    ctx.stroke();
  }
  // compute min/max
  const data = chartData.slice(-110);
  const min = Math.min(...data, START_PRICE);
  const max = Math.max(...data, START_PRICE);
  const pad = (max-min) * 0.12 || 10;
  const ymin = min - pad;
  const ymax = max + pad;
  // line
  ctx.beginPath();
  for(let i=0;i<data.length;i++){
    const x = (i/(110)) * w;
    const y = h - ((data[i]-ymin)/(ymax-ymin)) * h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  // color gradient based on last slope
  const lastSlope = (data[data.length-1] - (data[data.length-2]||data[data.length-1])) || 0;
  const grad = ctx.createLinearGradient(0,0,w,0);
  grad.addColorStop(0, lastSlope>=0 ? '#7bed9f' : '#ff8b6a');
  grad.addColorStop(1, '#ffffff10');
  ctx.strokeStyle = grad;
  ctx.lineWidth = 2.8;
  ctx.stroke();

  // draw last price bubble
  if(data.length>0){
    const x = ((data.length-1)/110) * w;
    const y = h - ((data[data.length-1]-ymin)/(ymax-ymin)) * h;
    ctx.beginPath();
    ctx.fillStyle = lastSlope>=0 ? '#7bed9f' : '#ff8b6a';
    ctx.arc(x,y,6,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#0b1020';
    ctx.font = '12px monospace';
    ctx.fillText('$'+data[data.length-1].toFixed(2), x+10, y-10);
  }
}

/* === Run / Control handlers === */
function startRun(){
  if(running) return;
  tick = 1; // index into SCRIPTED and NEWS_MAP
  running = true;
  chartData = [START_PRICE];
  price = START_PRICE;
  cash = 10000; holdings = 0; portfolio = 10000;
  meter = 50; lastTradeTick = -999; passiveBalancedTimer = 0;
  inPlayStart = Date.now();
  pushLog('Run started.');
  updateUI();
  scheduleNextTick();
  statusEl.textContent = 'Status: Running';
  document.getElementById('start').disabled = true;
}
function scheduleNextTick(){
  if(!running) return;
  const duration = Math.max(100, TICK_DURATION_BASE / speed);
  timerId = setTimeout(()=>{
    applyScriptTick();
    if(tick > TICKS_TOTAL){ finishRun(); } else scheduleNextTick();
  }, duration);
}
function pauseRun(){
  if(!running) return;
  clearTimeout(timerId); running = false; statusEl.textContent = 'Status: Paused'; pushLog('Paused.');
}
function resumeRun(){
  if(running) return;
  running = true; statusEl.textContent = 'Status: Running'; pushLog('Resumed.'); scheduleNextTick();
}
function stepTick(){
  if(running){ pushLog('Cannot step while running.'); return; }
  tick = Math.max(1, tick+1);
  applyScriptTick();
}
function resetRun(){
  clearTimeout(timerId);
  running = false; tick = 0; chartData = []; price = START_PRICE;
  cash = 10000; holdings = 0; portfolio = 10000; meter = 50;
  document.getElementById('start').disabled = false;
  newsEl.textContent = 'No news yet — the market is calm.';
  pushLog('Reset done.');
  drawChart(); recalcPortfolio(); updateUI();
  statusEl.textContent = 'Status: Ready';
  summaryEl.textContent = 'Start a run to see the summary here.';
}

/* === End-run logic and scoring === */
function finishRun(){
  clearTimeout(timerId);
  running = false;
  document.getElementById('start').disabled = false;
  statusEl.textContent = 'Status: Finished';
  pushLog('Run finished.');
  // compute calmness and discipline
  const calmness = clamp(100 - Math.abs(meter-50)*2, 0, 100);
  const discipline = clamp((portfolio/10000)*50 + (calmness/2), 0, 100);
  summaryEl.innerHTML = `<div>Final Net Worth: <span class="${portfolio>=20000?'success':'danger'}">${money(portfolio)}</span></div>
    <div>Final Meter: ${Math.round(meter)}</div>
    <div>Calmness: ${Math.round(calmness)}</div>
    <div>Discipline Score: ${Math.round(discipline)}</div>
    <div class="note">Win requires Net Worth ≥ $20,000 AND Meter between 40–60.</div>`;
  pushLog('Summary: ' + JSON.stringify({portfolio:portfolio, meter:meter}));
}

/* === Init UI bindings === */
window.addEventListener('load', ()=>{
  logEl = document.getElementById('log');
  priceEl = document.getElementById('price');
  cashEl = document.getElementById('cash');
  portEl = document.getElementById('portfolio');
  holdingsEl = document.getElementById('holdings');
  meterFillEl = document.getElementById('meter-fill');
  meterNumEl = document.getElementById('meter-number');
  newsEl = document.getElementById('news');
  tickEl = document.getElementById('tick');
  timerEl = document.getElementById('timer');
  statusEl = document.getElementById('status');
  summaryEl = document.getElementById('summary');
  chartCanvas = document.getElementById('chart');
  ctx = chartCanvas.getContext('2d');
  drawChart();
  updateUI();
  document.getElementById('buy').addEventListener('click', ()=>{ buyPercent(0.10); recalcPortfolio(); updateUI(); });
  document.getElementById('sell').addEventListener('click', ()=>{ sellPercent(0.10); recalcPortfolio(); updateUI(); });
  document.getElementById('allin').addEventListener('click', ()=>{ allIn(); recalcPortfolio(); updateUI(); });
  document.getElementById('panic').addEventListener('click', ()=>{ panicSell(); recalcPortfolio(); updateUI(); });
  document.getElementById('start').addEventListener('click', ()=>startRun());
  document.getElementById('reset').addEventListener('click', ()=>resetRun());
  document.getElementById('pause').addEventListener('click', ()=>pauseRun());
  document.getElementById('resume').addEventListener('click', ()=>resumeRun());
  document.getElementById('step').addEventListener('click', ()=>stepTick());
  document.getElementById('speed').addEventListener('input',(e)=>{ speed = parseFloat(e.target.value); pushLog('Speed set to x'+speed); });
});
</script>
</body>
</html>
